pipeline {
    agent any

    environment {
        NAMESPACE = "flightbooking-dev"
    }

    stages {
        stage('Crear namespace si no existe') {
            steps {
                withCredentials([file(credentialsId: 'kubeconfig-jenkins', variable: 'KUBECONFIG')]) {
                    sh '''
                    if ! kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
                      kubectl create namespace "$NAMESPACE"
                    fi
                    '''
                }
            }
        }

        // Etapa opcional manual para aplicar los volúmenes una única vez
        stage('(Manual) Aplicar volúmenes PV y PVC') {
            when {
                beforeInput true
                expression {
                    return false // <- Cambiar a true SOLO si es primera vez o se va a borrar todo el cluster
                }
            }
            steps {
                input message: "¿Aplicar volúmenes PV/PVC de Kafka y Zookeeper? (Solo si es realmente necesario)"
                withCredentials([file(credentialsId: 'kubeconfig-jenkins', variable: 'KUBECONFIG')]) {
                    dir('k8/kafka-zk') {
                        sh '''
                        # Zookeeper
                        kubectl apply -f 0-pv-zookeeper.yaml
                        kubectl apply -f 1-pvc-zookeeper.yaml -n "$NAMESPACE"

                        # Kafka
                        kubectl apply -f 0-pv-kafka.yaml
                        kubectl apply -f 1-pvc-kafka.yaml -n "$NAMESPACE"
                        '''
                    }
                }
            }
        }

        stage('Desplegar Zookeeper') {
            steps {
                withCredentials([file(credentialsId: 'kubeconfig-jenkins', variable: 'KUBECONFIG')]) {
                    dir('k8/kafka-zk') {
                        sh '''
                        kubectl apply -f 2-configmap-zookeeper.yaml -n "$NAMESPACE"
                        kubectl apply -f 3-deployment-zookeeper.yaml -n "$NAMESPACE"
                        kubectl apply -f 4-service-zookeeper.yaml -n "$NAMESPACE"
                        '''
                    }
                }
            }
        }

        stage('Esperar Zookeeper listo') {
            steps {
                withCredentials([file(credentialsId: 'kubeconfig-jenkins', variable: 'KUBECONFIG')]) {
                    sh '''
                    echo "Esperando que Zookeeper esté listo..."
                    kubectl wait --for=condition=ready pod -l app=zookeeper -n "$NAMESPACE" --timeout=90s
                    '''
                }
            }
        }

        stage('Desplegar Kafka') {
            steps {
                withCredentials([file(credentialsId: 'kubeconfig-jenkins', variable: 'KUBECONFIG')]) {
                    dir('k8/kafka-zk') {
                        sh '''
                        kubectl apply -f 2-configmap-kafka.yaml -n "$NAMESPACE"
                        kubectl apply -f 3-deployment-kafka.yaml -n "$NAMESPACE"
                        kubectl apply -f 4-service-kafka.yaml -n "$NAMESPACE"
                        '''
                    }
                }
            }
        }
    }
}
